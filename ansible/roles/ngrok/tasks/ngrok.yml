- name: ngrok install
  community.general.snap:
    name: ngrok
    update_cache: true

- name: ngrok create system user
  ansible.builtin.user:
    name: ngrok
    system: true
    home: /etc/ngrok
    create_home: true
    shell: /usr/sbin/nologin
    password: "!"
    
- name: ngrok make config dir
  ansible.builtin.file:
    path: /etc/ngrok/
    state: directory
    owner: ngrok
    group: ngrok

- name: ngrok user config setup
  template:
    src: ngrok_config.j2
    dest: "/etc/ngrok/ngrok.yml"

- name: ngrok systemd service
  template:
    src: ngrok_systemd_service.j2
    dest: "/lib/systemd/system/ngrok@.service"
  register: setup_ngrok_config

- name: ngrok restart service
  ansible.builtin.systemd:
    name: ngrok@{{item}}.service    #name after the @ must match the name of the endpoint in the config 
    daemon_reload: true
    state: restarted
    enabled: true
  loop: "{{ ngrok_endpoints }}"
  when: setup_ngrok_config.changed